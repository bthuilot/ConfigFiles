cjModules.define(function(){"use strict";return function(e,t){function n(){"function"==typeof D&&D()}function a(e,t){for(var n=[],a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n}function o(e,t){var n={alt:"json","max-results":9999999};t&&Object.keys(t).forEach(function(e){n[e]=t[e]});var a=cjBasics.urls.create("https://www.google.com/m8/feeds/"+e,n);return g.request(a,{headers:{"GData-Version":"3.0"},fetchAs:"json"},{scope:O})}function r(e){return o("contacts/default/thin",e).then(function(e){return e.feed.entry?e.feed.entry.map(function(e){return"people/c"+cjBasics.convertBase(e.id.$t.split("/base/")[1],16,10)}):[]})}function i(e){var t=cjBasics.urls.create(P+"people:batchGet",{resourceNames:e,fields:"responses(requestedResourceName,person(names(displayName,familyName),photos/url))","requestMask.includeField":"person.names,person.photos"});return g.request(t,{fetchAs:"json"},{scope:O})["catch"](function(){return new Promise(function(t){setTimeout(function(){i(e).then(t)},4e3)})})}function c(e){return r(e).then(function(e){return a(e,50).map(i)}).then(function(e){return Promise.all(e)}).then(function(e){var t={};e.forEach(function(e){e.responses.forEach(function(e){var n=e.requestedResourceName;if(t[n]){if(t[n].photo)return;t[n].photo=e.person.photos?e.person.photos[0].url:null}else{var a=e.person&&e.person.names&&e.person.names[0].displayName;if(!a)return;t[n]={id:n,name:a,sortValue:a.toLowerCase(),familySortValue:e.person.names[0].familyName?e.person.names[0].familyName.toLowerCase()+"-"+a.toLowerCase():a.toLowerCase(),photo:e.person.photos?e.person.photos[0].url:null}}})});var n=[];return Object.keys(t).forEach(function(e){n.push(t[e])}),n}).then(function(e){return q?e.sort(function(e,t){return e.familySortValue>t.familySortValue?1:-1}):e.sort(function(e,t){return e.sortValue>t.sortValue?1:-1})})}function l(){var e="https://www.google.com/contacts/?authuser="+g.account.authuser+"#contact/new";bmRuntime.openTab(e)}function s(e){var t=cjMaterial.createElement("item");t.dataset.contactData=JSON.stringify(e);var n=e.name,a={withShell:!0,size:40};e.photo?(a.url=e.photo+"?sz="+(cjBasics.isRetina?80:40),a.color="#fff"):a.symbol=n[0]||" ";var o=cjMaterial.createElement("icon",a);t.appendChild(o);var r=document.createElement("div");return r.className="cj-md-item__body cj-md-item__header",r.textContent=n,t.appendChild(r),t}function d(e){return cjMaterial.createElement("emptystate",{color:I,label:"No contacts found",subLabel:"search"===e?"Try a synonym or more general keyword":"Please select a different group",iconName:"__mdi:contacts"})}function u(e){var t=e||{},n=cjBasics.urls.create(P+"people/me/connections",{pageSize:t.pageSize||"500",pageToken:t.pageToken,"requestMask.includeField":"person.names,person.photos",fields:"connections(resourceName,names/displayName,photos/url),nextPageToken",sortOrder:t.sortByLastName?"LAST_NAME_ASCENDING":"FIRST_NAME_ASCENDING"});return g.request(n,{fetchAs:"json"},{scope:O}).then(function(e){if(0===Object.keys(e).length)return{contacts:[]};for(var t=[],n=e.connections,a=0;a<n.length;a++){var o=n[a];o.names&&o.names[0].displayName&&t.push({id:o.resourceName,name:o.names[0].displayName,photo:o.photos?o.photos[0].url:null})}return{contacts:t,nextPageToken:e.nextPageToken}})["catch"](function(){return new Promise(function(t){setTimeout(function(){u(e).then(t)},4e3)})})}function m(e){for(var t=document.createDocumentFragment(),n=0;n<e.length;n++)if(e[n].name){var a=s(e[n]);t.appendChild(a)}return t}function p(t){bmRuntime.toggleLoading("on",e),w.textContent="";var n=document.createElement("div");w.appendChild(n),D=null,c({q:t}).then(function(t){if(0===t.length){var a=d("search");n.appendChild(a)}else{var o=m(t);n.appendChild(o)}bmRuntime.toggleLoading("off",e)})}function h(t){bmRuntime.toggleLoading("on",e),w.textContent="";var n=document.createElement("div");w.appendChild(n),D=null,c({group:t}).then(function(t){if(0===t.length){var a=d("group");n.appendChild(a)}else{var o=m(t);n.appendChild(o)}bmRuntime.toggleLoading("off",e)})}function f(){function t(e){h(e)}bmRuntime.toggleLoading("on",e),w.textContent="";var n=document.createElement("div");w.appendChild(n);var a,o=new Promise(function(e){a=e}),r="";g.cache.getItem("bm__cache__contacts__starred").then(function(e){if(Array.isArray(e)&&(r=JSON.stringify(e),e.length>0)){var t=cjMaterial.createElement("subheader",{color:I,label:"Starred"});n.appendChild(t);var a=m(e);n.appendChild(a)}}),x.then(function(){return c({group:M})}).then(function(e){if(a(),JSON.stringify(e)!==r&&(n.textContent="",g.cache.setItem("bm__cache__contacts__starred",e),0!==e.length)){var t=cjMaterial.createElement("subheader",{color:I,label:"Starred"});n.appendChild(t);var o=m(e);n.appendChild(o)}});var i=document.createElement("div");w.appendChild(i);var l,s=new Promise(function(e){l=e}),p="";g.cache.getItem("bm__cache__contacts__all").then(function(e){if(Array.isArray(e))if(p=JSON.stringify(e),e.length>0){var t=cjMaterial.createElement("subheader",{color:I,label:"All Contacts"});i.appendChild(t);var n=m(e);i.appendChild(n)}else{i.textContent="";var a=d("group");i.appendChild(a)}});var h,f=new Promise(function(e){h=e});D=function(){bmRuntime.toggleLoading("on",e),f.then(function(n){f=new Promise(function(e){h=e}),u({pageSize:"500",sortByLastName:q,pageToken:n}).then(function(n){t(n.nextPageToken);var a=m(n.contacts);i.appendChild(a),bmRuntime.toggleLoading("off",e)})})},z.then(function(){return u({pageSize:"250",sortByLastName:q})}).then(function(e){var n=e.contacts;if(t(e.nextPageToken),l(),JSON.stringify(n)!==p){if(i.textContent="",g.cache.setItem("bm__cache__contacts__all",n),0===n.length){var a=d("group");return void i.appendChild(a)}var o=cjMaterial.createElement("subheader",{color:I,label:"All Contacts"});i.appendChild(o);var r=m(n);i.appendChild(r)}}),Promise.all([o,s]).then(function(){bmRuntime.toggleLoading("off",e)})}function v(){var e=cjMaterial.createElement("appbar",{color:I,secondary:!0});S=cjMaterial.createElement("iconbutton",{iconName:"__mdi:menu",onClick:function(){if(V){V=!1,R.value="",S.updateIcon({iconName:"__mdi:menu"}),k.textContent=T;var e=A.selected;"all"===e?f():h(e)}else L.open()}}),e.appendChild(S),k=cjMaterial.createElement("title",{label:"All Contacts"}),e.appendChild(k);var t=cjMaterial.createElement("selectbox",{onChange:function(){var e="last"===t.selected;if(q=e,browserStorage.sync.setItem("contactsSortByLastName",e),V){var n=R.value;return void p(n)}var a=A.selected;"all"===a?f():h(a)},options:[{value:"last",label:"Sort by last name",selected:q},{value:"first",label:"Sort by first name",selected:!q}]});return e.appendChild(t),e}function b(e){var t=e.toLowerCase();return t.indexOf("work")!==-1?"__mdi:work":t.indexOf("school")!==-1||t.indexOf("university")!==-1||t.indexOf("study")!==-1?"__mdi:school":t.indexOf("starred")!==-1?"__mdi:star":t.indexOf("youtube")!==-1?"__mdi:video_youtube":"__mdi:label"}function C(){return o("groups/default/thin").then(function(e){var t=[];return e.feed.entry.forEach(function(e){var n=e.id.$t,a=e.title.$t;if(a.indexOf("System Group: ")===-1)return a.indexOf("Starred in Android")!==-1?void(M=n):void t.push({id:n,label:a})}),t})}function _(){L=cjMaterial.createElement("drawer",{color:I}),bmRuntime.toggleLoading("on",L);var e=bmElements.createElement("servicelogo",{label:"Contacts",color:"color"});L.appendChild(e);var t={all:{label:"All Contacts",iconName:"__mdi:people"}};return x.then(function(e){e.forEach(function(e){t[e.id]={label:e.label,iconName:b(e.label)}}),A=bmElements.createElement("drawertabs",{items:t,onChange:function(e){var n=A.selected;"all"===n?f():h(n),k.textContent=t[e].label},selected:"all"}),L.appendChild(A),bmRuntime.toggleLoading("off",L)}),L}function y(e){var t=cjBasics.urls.create(P+e,{fields:"addresses,ageRange,biographies,birthdays,braggingRights,coverPhotos,emailAddresses,etag,events,genders,imClients,interests,locales,memberships,metadata,names,nicknames,occupations,organizations,phoneNumbers,photos,relations,relationshipInterests,relationshipStatuses,residences,resourceName,skills,taglines,urls"});return g.request(t,{fetchAs:"json"},{scope:O})["catch"](function(){return new Promise(function(t){setTimeout(function(){y(e).then(t)},4e3)})})}function N(e){var t=cjMaterial.createElement("item");e.onClick?t.addEventListener("click",function(){e.onClick()}):t.classList.add("no-action");var n=cjMaterial.createElement("icon",{name:e.iconName});t.appendChild(n);var a=document.createElement("div");a.className="cj-md-item__body",t.appendChild(a);var o=document.createElement("div");if(o.className="cj-md-item__header",o.textContent=e.value,a.appendChild(o),e.subLabel){var r=cjMaterial.createElement("secondarytext",{label:e.subLabel});a.appendChild(r)}return t}function E(t){var n=cjMaterial.createElement("container");n.classList.add("contact-details"),bmRuntime.toggleLoading("on",n);var a=document.createElement("header");a.className="contact-details__header",n.appendChild(a);var o=cjMaterial.createElement("iconbutton",{iconName:"__mdi:arrow_back",onClick:function(){e.removeChild(n)}});o.classList.add("contact-details__back"),a.appendChild(o);var r=t.name,i=cjMaterial.createElement("title",{label:r});i.classList.add("contact-details__name"),a.appendChild(i);var c={withShell:!0,size:80};t.photo?(c.url=t.photo+"?sz="+(cjBasics.isRetina?160:80),c.color="#b3b3b3"):c.symbol=r[0]||" ";var l=cjMaterial.createElement("icon",c);l.classList.add("contact-details__photo"),a.appendChild(l);var s=cjMaterial.createElement("container",{scrollable:!0,shadow:"onScroll"});n.appendChild(s),y(t.id).then(function(e){var t=document.createDocumentFragment();if(Array.isArray(e.emailAddresses)&&e.emailAddresses.length>0&&e.emailAddresses.forEach(function(e){var n=N({iconName:"__mdi:email",value:e.value,subLabel:e.formattedType,onClick:function(){bmRuntime.openTab("mailto:"+e.value)}});t.appendChild(n)}),Array.isArray(e.phoneNumbers)&&e.phoneNumbers.length>0&&e.phoneNumbers.forEach(function(e){var n=N({iconName:"__mdi:call",value:e.value,subLabel:e.formattedType,onClick:function(){bmRuntime.openTab(cjBasics.urls.create("https://hangouts.google.com/",{authuser:g.account.authuser,pn:e.canonicalForm,action:"chat"}))}});t.appendChild(n)}),Array.isArray(e.addresses)&&e.addresses.length>0&&e.addresses.forEach(function(e){var n=N({iconName:"__mdi:place",value:e.formattedValue,subLabel:e.formattedType,onClick:function(){bmRuntime.openTab(cjBasics.urls.create("https://maps.google.com/",{authuser:g.account.authuser,q:e.formattedValue}))}});t.appendChild(n)}),Array.isArray(e.birthdays)&&e.birthdays.length>0&&e.birthdays.forEach(function(e){var n=N({iconName:"__mdi:cake",value:cjBasics.datetime.printDate(e.date)});t.appendChild(n)}),0===t.children.length){var a=document.createElement("div");a.className="no-contact-info",a.textContent="No more contact info found",t.appendChild(a)}s.appendChild(t),bmRuntime.toggleLoading("off",n)}),e.appendChild(n)}function j(){bmRuntime.toggleLoading("on",e),x=C();var t=_();e.appendChild(t);var a=bmElements.createElement("pageheader",{color:I,pageId:"contacts",searchboxProperties:{onSubmit:function(e){V||(V=!0,T=k.textContent,k.textContent="Search",S.updateIcon({iconName:"__mdi:arrow_back"})),p(e)},onSubmitAlt:function(e){bmRuntime.openTab("https://www.google.com/contacts/?authuser="+g.account.authuser+"#contacts/search/"+e)}}});R=a.searchbox;var o=cjMaterial.createElement("fab",{label:"New Contact",iconName:"__mdi:add",onClick:l});e.appendChild(o),e.appendChild(a),B(R.select);var r=v();e.appendChild(r),w=cjMaterial.createElement("container",{scrollable:!0,shadow:!0,onScrollBottom:n}),w.addEventListener("click",function(e){var t=e.target.dataset.contactData;t&&E(JSON.parse(t))}),e.appendChild(w),f(),g.auth.getAccessToken(O)["catch"](function(t){var n=bmElements.createElement("fulldialog",{serviceLogo:{label:"Contacts"},iconName:"contacts",message:"Before you can use this page, you need to give access to load your Google Contacts",actionLabel:"Give permission",action:t.authorize});e.appendChild(n)})}var w,L,S,k,A,x,M,R,T,B=t.onPageDisplay,O=["https://www.googleapis.com/auth/contacts.readonly"],P="https://people.googleapis.com/v1/",I="#3367d6",q=!1,z=browserStorage.sync.getItem("sortByLastName").then(function(e){e&&(q=!0)}),D=null,V=!1;j()}});