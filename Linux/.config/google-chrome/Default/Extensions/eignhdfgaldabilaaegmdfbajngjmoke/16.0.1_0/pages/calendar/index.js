cjModules.define(function(){"use strict";return function(e,t){function n(t){var n=bmRuntime.i18n("cj_i18n_00264","Before you can use this page, you need to give access to load your Google Calendar Data");if(!E&&"notAuthorized"===t.error){E=!0,e.textContent="";var a=bmElements.createElement("fulldialog",{serviceLogo:{label:bmRuntime.i18n("cj_i18n_00302","Calendar")},iconName:"calendar",message:n,actionLabel:bmRuntime.i18n("cj_i18n_00224","Give permission"),action:t.authorize});e.appendChild(a)}}function a(e){return e?"string"==typeof e?moment(e.replace("Z","+00:00"),["YYYY-MM-DDTHH:mm:ssZZ","YYYY-MM-DDTHHmmssZZ","YYYYMMDDTHHmmssZZ","YYYY-MM-DDTHH:mm:ss","YYYY-MM-DDTHHmmss","YYYYMMDDTHHmmss","YYYY-MM-DDTHH:mmZZ","YYYY-MM-DDTHHmmZZ","YYYYMMDDTHHmmZZ","YYYY-MM-DDTHH:mm","YYYY-MM-DDTHHmm","YYYYMMDDTHHmm","YYYY-MM-DDTHH","YYYYMMDDTHH","YYYY-MM-DD","YYYYMMDD"]):moment(e):null}function r(e,t){var n=e.title?e.title.toLowerCase():"",a=t.title?t.title.toLowerCase():"";return e.allday&&t.allday?n===a?e.calendarUrl>t.calendarUrl?1:-1:n>a?1:-1:e.allday?-1:t.allday?1:e.start>t.start?1:e.start<t.start?-1:n===a?e.calendarUrl>t.calendarUrl?1:-1:n>a?1:-1}function o(e,t){var r=moment().subtract("days",D),o=moment().add("days",D),i=t?"H:mm":"h:mma",c=e.foregroundColor,m=e.backgroundColor,l=cjBasics.urls.create(M+"calendars/"+encodeURIComponent(e.id)+"/events",{timeMin:r.toISOString(),timeMax:o.toISOString(),maxResults:"2500",orderBy:"startTime",singleEvents:"true",fields:"items(end/dateTime,endTimeUnspecified,htmlLink,start(date,dateTime),summary)"});return g.request(l,{fetchAs:"json"},{scope:y}).then(function(e){for(var t=[],n=0;n<e.items.length;n++){var r=e.items[n];if("undefined"!=typeof r.htmlLink){var o=a(r.start.dateTime||r.start.date),l="date"in r.start,d=null;l||(d=o.format(i),r.endTimeUnspecified||(d+=" - "+a(r.end.dateTime).format(i))),t.push({foregroundColor:c,backgroundColor:m,title:r.summary,start:o.valueOf(),allday:l,calendarUrl:r.htmlLink,timeString:d})}}return t},n)}function i(){var e=_.querySelector(".today");e&&(_.scrollTop=e.offsetTop-e.offsetHeight-48)}function c(e){_.textContent="";var t=JSON.parse(e);if(0===t.length){var n=cjMaterial.createElement("emptystate",{color:"#4285f4",iconName:"__mdi:event",label:bmRuntime.i18n("cj_i18n_00265","No events found"),subLabel:bmRuntime.i18n("cj_i18n_00266","To add a new event, click the red button in the bottom right corner")});return void _.appendChild(n)}for(var a,r=document.createDocumentFragment(),o=0;o<t.length;o++){var c=t[o],m=c.month;if(0===o||m!==t[o-1].month){a&&r.appendChild(a),a=document.createElement("div"),a.className="month-container",a.dataset.month=m.toString();var l=document.createElement("div");l.className="month",l.textContent=R[m],a.appendChild(l)}var d=document.createElement("div");d.className="day-container",c.isToday&&d.classList.add("today");var s=document.createElement("div");s.className="day-description",d.appendChild(s);var u=document.createElement("div");u.className="day-number",u.textContent=c.dayNumber,s.appendChild(u);var h=document.createElement("div");h.className="day-name",h.textContent=c.dayName,s.appendChild(h);var p=document.createElement("div");if(p.className="event-container",d.appendChild(p),0===c.events.length){var f=document.createElement("div");f.className="no-events",f.textContent=bmRuntime.i18n("cj_i18n_00267","No events today"),p.appendChild(f)}else c.events.forEach(function(e){var t=document.createElement("div");t.classList.add("event-item"),t.addEventListener("click",function(){bmRuntime.openTab(e.calendarUrl.replace("https://www.google.com/calendar/event",j))});var n=e.title,a=e.allday===!0;a||(n+="\n"+e.timeString),e.backgroundColor&&(t.style.color=e.foregroundColor,t.style.backgroundColor=e.backgroundColor),t.textContent=n,p.appendChild(t)});a.appendChild(d)}r.appendChild(a),_.appendChild(r),i()}function m(){return Promise.all([L.list(),w,k]).then(function(e){var t=e[0],n=e[1],a=[],r=t.map(function(e){return e.selected!==!0?Promise.resolve():o(e,n).then(function(e){e&&(a=a.concat(e))})});return Promise.all(r).then(function(){return a.sort(function(e,t){return e.start-t.start})})})}function l(){return bmRuntime.toggleLoading("on",_),m().then(function(e){var t=moment(),n={},a=t.format("YYYYMMDD");n[a]={isToday:!0,dayId:a,dayName:t.format("ddd"),dayNumber:t.format("D"),month:t.month(),events:[]},e.forEach(function(e){var t=moment(e.start),a=t.format("YYYYMMDD");n[a]||(n[a]={dayId:a,dayName:t.format("ddd"),dayNumber:t.format("D"),month:t.month(),events:[]}),n[a].events.push(e)});var o=Object.keys(n).map(function(e){return n[e].events=n[e].events.sort(r),n[e]}).sort(function(e,t){return e.dayId>t.dayId?1:-1});return JSON.stringify(o)}).then(function(e){return e===v?null:(v=e,g.cache.setItem("bm__cache__calendar__events",e),c(e))}).then(function(){bmRuntime.toggleLoading("off",_),T=!0})}function d(e){var t=cjMaterial.createElement("item"),n=cjMaterial.createElement("icon",{name:"__mdi:cj_check_box_filled",color:e.backgroundColor});t.appendChild(n);var a=document.createElement("div");return a.className="cj-md-item__body",a.textContent=e.label,t.appendChild(a),t.addEventListener("click",function(n){var a=t.classList.toggle("on");L.changeSelected(e.id,a).then(l),n.stopPropagation()}),e.selected&&t.classList.add("on"),t}function s(){var e=cjMaterial.createElement("appbar",{secondary:!0,light:!0}),t=cjMaterial.createElement("iconbutton",{iconName:"__mdi:menu",onClick:function(){Y.open()}});e.appendChild(t),b=cjMaterial.createElement("title",{label:R[N]}),e.appendChild(b);var n=cjMaterial.createElement("iconbutton",{iconName:"__mdi:refresh",onClick:l});e.appendChild(n);var a=cjMaterial.createElement("iconbutton",{iconName:"__mdi:today",onClick:i});return e.appendChild(a),e}function u(){var e=cjMaterial.createElement("drawer"),t=bmElements.createElement("servicelogo",{label:bmRuntime.i18n("cj_i18n_00302","Calendar"),color:"color"});return e.appendChild(t),L.list().then(function(e){var t=document.createElement("ul");e.forEach(function(e){var n=d({selected:e.selected,label:e.summary,id:e.id,backgroundColor:e.backgroundColor});t.appendChild(n)}),Y.appendChild(t)}),e}function h(){return _=cjMaterial.createElement("container",{scrollable:!0,shadow:"onScroll"}),_.addEventListener("scroll",function(){for(var e=_.querySelectorAll(".month-container"),t=e[0].dataset.month,n=1;n<e.length&&!(_.scrollTop<e[n].offsetTop-68);n++)t=parseInt(e[n].dataset.month,10);b.textContent=R[t]}),l(),g.cache.getItem("bm__cache__calendar__events").then(function(e){e&&e.length>0&&!T&&(v=e,c(e))}),_}function p(e){var t=cjBasics.urls.create(j,{q:e});bmRuntime.openTab(t)}function f(){var t=document.createDocumentFragment(),n=bmElements.createElement("pageheader",{pageId:"calendar",light:!0,searchboxProperties:{color:"#4285f4",onSubmit:p,submitInNewTab:!0}});t.appendChild(n);var a=s();t.appendChild(a);var r=h();t.appendChild(r),Y=u(),t.appendChild(Y);var o=cjMaterial.createElement("fab",{label:bmRuntime.i18n("cj_i18n_00268","New event"),iconName:"__mdi:add",onClick:function(){bmRuntime.openTab(j+"?action=TEMPLATE")}});t.appendChild(o),e.appendChild(t),C(n.searchbox.select)}var v,b,_,Y,C=t.onPageDisplay,y=["https://www.googleapis.com/auth/calendar"],M="https://www.googleapis.com/calendar/v3/",j="https://calendar.google.com/calendar/b/"+g.account.authuser+"/render",D=28,E=!1,T=!1,H=new Date,N=H.getMonth(),R=[bmRuntime.i18n("cj_i18n_00165","January"),bmRuntime.i18n("cj_i18n_00166","February"),bmRuntime.i18n("cj_i18n_00167","March"),bmRuntime.i18n("cj_i18n_00168","April"),bmRuntime.i18n("cj_i18n_00169","May"),bmRuntime.i18n("cj_i18n_00170","June"),bmRuntime.i18n("cj_i18n_00171","July"),bmRuntime.i18n("cj_i18n_00172","August"),bmRuntime.i18n("cj_i18n_00173","September"),bmRuntime.i18n("cj_i18n_00174","October"),bmRuntime.i18n("cj_i18n_00175","November"),bmRuntime.i18n("cj_i18n_00176","December")],k=cjBasics.loadScriptFile("scripts/moment-with-langs.js").then(function(){moment.lang("relative-formatter",{relativeTime:{future:"%s",past:"%s",s:"1s",ss:"%ds",m:"1m",mm:"%dm",h:"1h",hh:"%dh",d:"1d",dd:"%dd",M:"1mo",MM:"%dmo",y:"1yr",yy:"%dy"}})}),w=function(){var e="https://www.googleapis.com/calendar/v3/users/me/settings/format24HourTime?fields=value",t=g.request(e,{fetchAs:"json"},{scopes:y}).then(function(e){var t=JSON.parse(e.value);return g.cache.setItem("bm__cache__calendar__24hours",t),t});return g.cache.getItem("bm__cache__calendar__24hours").then(function(e){return"boolean"==typeof e?e:t})}(),L=function(){function e(){return o.then(function(){return a})}function t(e,t){for(var r=0;r<a.length;r++)if(a[r].id===e){a[r].selected=t;break}var o=M+"users/me/calendarList/"+encodeURIComponent(e);return g.request(o,{method:"patch",body:JSON.stringify({selected:t}),headers:{"Content-Type":"application/json"}},{scope:y})["catch"](n)}var a,r=cjBasics.urls.create(M+"users/me/calendarList",{maxResults:"250",fields:"items(backgroundColor,foregroundColor,id,selected,summary)"}),o=g.request(r,{fetchAs:"json"},{scope:y}).then(function(e){a=e.items||[]},n);return{list:e,changeSelected:t}}();f()}});